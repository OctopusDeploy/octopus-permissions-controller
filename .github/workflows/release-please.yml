name: Release Please
on:
  push:
    branches:
      - main

# These permissions are used for the commit against the release-please branch after running the `make` step
# The extra token is used for release-please to create the PR to allow actions to run against it
permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: '${{ secrets.GHA_TOKEN }}'
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      # If a release PR was created/updated, rebuild the installer with the new version
      - uses: actions/checkout@v4
        if: ${{ steps.release.outputs.pr }}
        with:
          ref: ${{ steps.release.outputs.head_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build installer with new version
        if: ${{ steps.release.outputs.pr }}
        run: |
          VERSION=${{ steps.release.outputs.version }}
          make build-installer IMG=octopusdeploy/octopus-permissions-controller:${VERSION}

      - name: Commit generated files
        if: ${{ steps.release.outputs.pr }}
        run: |
          VERSION=${{ steps.release.outputs.version }}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add config/manager/kustomization.yaml dist/install.yaml
          git diff --staged --quiet || git commit -m "chore: rebuild installer with version ${VERSION}"
          git push