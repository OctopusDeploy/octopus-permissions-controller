name: Publish Helm chart

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        required: true
        type: string
        description: "The version of the helm chart to publish (e.g. v1.2.3-preview.1)"

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ env.version }}
      package_name: ${{ env.package_name }}

    steps:
      - name: Generate workflow application version
        if: github.event_name == 'workflow_dispatch'
        id: release_version
        run: |
          echo "version=${{ inputs.version }}" >> $GITHUB_ENV
          echo "package_name=octopus-permissions-controller-chart-${{ inputs.version }}.tgz" >> $GITHUB_ENV

      - name: Generate release application version
        if: github.event_name == 'release'
        id: workflow_version
        run: |
          tag=${{ github.event.release.tag_name }}
          echo "version=${tag#v}" >> $GITHUB_ENV
          echo "package_name=octopus-permissions-controller-chart-${{ github.event.release.tag_name }}.tgz" >> $GITHUB_ENV

  package:
    needs: version
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4

      # Our release process currently does not mesh with the way kubebuilder links the image tag, so we manually update the values.yaml tag here
      - name: Update manager image tag using release version
        run: yq e -i '.manager.image.tag = "${{ needs.version.outputs.version }}"' ./dist/chart/values.yaml

      - name: Package Chart
        run: helm package './dist/chart' --version '${{ needs.version.outputs.version }}' --app-version '${{ needs.version.outputs.version }}'

      - uses: actions/upload-artifact@v4
        name: Upload packaged chart
        with:
          name: "${{ needs.version.outputs.package_name }}"
          path: "${{ github.workspace }}/${{ needs.version.outputs.package_name }}"

  publish_to_octopus:
    runs-on: ubuntu-latest
    needs:
      - version
      - package
    permissions:
      id-token: write
    steps:
      - name: Download packaged chart
        uses: actions/download-artifact@v4
        with:
          name: "${{ needs.version.outputs.package_name }}"

      - name: Login to Octopus
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ vars.OCTOPUS_SERVER }}
          service_account_id: ${{ secrets.OCTOPUS_SERVICE_ACCOUNT }}

      - name: Push helm chart to Octopus Deploy üêô
        uses: OctopusDeploy/push-package-action@v3
        with:
          space: "Modern Deployments"
          packages: ${{ needs.version.outputs.package_name }}
          overwrite_mode: IgnoreIfExists

      - name: Create a release in Octopus Deploy üêô
        uses: OctopusDeploy/create-release-action@v3
        with:
          space: "Modern Deployments"
          project: "Octopus Permissions Controller"
          release_number: ${{ needs.version.outputs.version }}
          package_version: ${{ needs.version.outputs.version }}
          ignore_existing: true
